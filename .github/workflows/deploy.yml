name: Deploy backend to server

on:
  push:
    branches:
      - main  
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Deploy to Ubuntu server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}  
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30m
          script: |
            echo "âœ… ConexÃ£o SSH estabelecida"

            echo "ğŸ” Adicionando chave SSH do GitHub ao known_hosts..."
            ssh-keyscan github.com >> ~/.ssh/known_hosts

            cd ~/Projects/Backend
            
            if [ -d "whatsapp-api/.git" ]; then
              echo "ğŸ”„ Atualizando repositÃ³rio existente (git pull)..."
              cd whatsapp-api
              git remote set-url origin git@github.com:andersonaguia/whatsapp-api.git
              git pull
            else
              echo "ğŸ› ï¸ Clonando repositÃ³rio..."
              git clone git@github.com:andersonaguia/whatsapp-api.git
              echo "âœ… Clone concluÃ­do!"
            fi
            echo "âœ… RepositÃ³rio sincronizado!"

            echo "ğŸ› ï¸ Exportando variÃ¡veis de ambiente..."
            export CELL_NUMBER=${{ secrets.CELL_NUMBER }}

            echo "ğŸ›‘ Derrubando container antigo..."
            docker compose down

            echo "ğŸš€ Subindo novo container com build atualizado..."
            CELL_NUMBER=$CELL_NUMBER docker compose up -d --build

            echo "âœ… Deploy concluÃ­do com sucesso!"





          
            
